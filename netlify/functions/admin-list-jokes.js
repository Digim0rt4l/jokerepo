const { getStore } = require("@netlify/blobs");
exports.handler=async(event,context)=>{try{const u=context&&context.clientContext&&context.clientContext.user;if(!u)return{statusCode:401,body:JSON.stringify({error:"Unauthorized"})};const store=getStore("jokerepo");const raw=await store.get("jokes",{type:"json"})||{};const jokes=Object.entries(raw).filter(([_,j])=>j&&j.deleted!==true&&typeof j.text==="string"&&j.text.trim()).map(([id,j])=>({id,text:j.text,score:j.score||0,ts:j.ts||0})).sort((a,b)=>{const sb=b.score||0,sa=a.score||0;return sb!==sa?sb-sa:(b.ts||0)-(a.ts||0)}).slice(0,5000);return{statusCode:200,headers:{"content-type":"application/json"},body:JSON.stringify({jokes})}}catch(e){return{statusCode:500,headers:{"content-type":"application/json"},body:JSON.stringify({error:String(e&&e.message||e)})}}};